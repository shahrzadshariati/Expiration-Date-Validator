- name: Analyze Certificate and Create Status Report
        run: |
          INPUT_FILE="log.rtcm.json.test"
          STATUS_FILE="expiration_status.txt"

          echo "--- Starting Certificate Analysis ---"
          if [ ! -s "$INPUT_FILE" ]; then
            echo "Input file '$INPUT_FILE' not found or is empty. Skipping analysis."
            # Create a status file indicating the input was missing
            echo -e "Status: Analysis Skipped\nReason: Input file was missing or empty." > $STATUS_FILE
            exit 0
          fi

          echo "Searching for message type 3081..."
          EXP_DATE_STRING=$(jq -r 'select(.msg_type == 3081) | .expiration | "\(.year)-\(.month)-\(.day) \(.hours):\(.minutes):\(.seconds)"' $INPUT_FILE | head -n 1)

          if [ -z "$EXP_DATE_STRING" ]; then
            echo "Message type 3081 not found. Cannot check expiration."
            echo -e "Status: Analysis Failed\nReason: Message type 3081 not found in log." > $STATUS_FILE
            exit 0
          fi

          # Convert dates to Unix timestamps for comparison
          EXP_TIMESTAMP=$(date -d "$EXP_DATE_STRING UTC" +%s)
          NOW_TIMESTAMP=$(date +%s)

          # --- Logic to create the status report file ---
          # Case 1: The certificate has already expired.
          if (( EXP_TIMESTAMP < NOW_TIMESTAMP )); then
            echo "ALERT: Certificate has already expired!"
            echo -e "Status: EXPIRED\nExpiration Date: $EXP_DATE_STRING UTC" > $STATUS_FILE
          # Case 2: The certificate is still valid.
          else
            DAYS_REMAINING=$(( (EXP_TIMESTAMP - NOW_TIMESTAMP) / 86400 ))
            # Sub-case 2a: It's valid but will expire in less than 30 days.
            if (( DAYS_REMAINING < 30 )); then
              echo "ALERT: Certificate is expiring in $DAYS_REMAINING day(s)!"
              echo -e "Status: OK (Expiring Soon)\nDays Remaining: $DAYS_REMAINING\nExpiration Date: $EXP_DATE_STRING UTC" > $STATUS_FILE
            # Sub-case 2b: It's valid and not expiring soon.
            else
              echo "Certificate is valid for $DAYS_REMAINING more days."
              echo -e "Status: OK\nDays Remaining: $DAYS_REMAINING\nExpiration Date: $EXP_DATE_STRING UTC" > $STATUS_FILE
            fi
          fi
          
          echo "--- Generated Status Report ---"
          # Also print the report to the main log for easy viewing
          cat $STATUS_FILE

      - name: Upload Expiration Status Report
        # This step now runs unconditionally to upload the status report
        uses: actions/upload-artifact@v4
        with:
          name: expiration-status-report
          path: expiration_status.txt
